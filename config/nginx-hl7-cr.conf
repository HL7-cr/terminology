# Configuración de Producción - Servidor de Paquetes HL7 Costa Rica# Configuración de Producción - Servidor de Paquetes HL7 Costa Rica

# Nginx# Nginx

# Ubicación: /etc/nginx/sites-available/hl7-cr# Ubicación: /etc/nginx/sites-available/hl7-cr



server {server {

    listen 80;    listen 80;

    server_name hl7.or.cr;    server_name hl7.or.cr;

        

    # Redirigir todo a HTTPS    # Redirigir todo a HTTPS

    return 301 https://$server_name$request_uri;    return 301 https://$server_name$request_uri;

}}



server {server {

    listen 443 ssl http2;    listen 443 ssl http2;

    server_name hl7.or.cr;    server_name hl7.or.cr;



    # Certificados SSL (Let's Encrypt)    # Certificados SSL (Let's Encrypt)

    ssl_certificate /etc/letsencrypt/live/hl7.or.cr/fullchain.pem;    ssl_certificate /etc/letsencrypt/live/hl7.or.cr/fullchain.pem;

    ssl_certificate_key /etc/letsencrypt/live/hl7.or.cr/privkey.pem;    ssl_certificate_key /etc/letsencrypt/live/hl7.or.cr/privkey.pem;

        

    # Configuración SSL moderna    # Configuración SSL moderna

    ssl_protocols TLSv1.2 TLSv1.3;    ssl_protocols TLSv1.2 TLSv1.3;

    ssl_ciphers HIGH:!aNULL:!MD5;    ssl_ciphers HIGH:!aNULL:!MD5;

    ssl_prefer_server_ciphers on;    ssl_prefer_server_ciphers on;



    # Logs    # Logs

    access_log /var/log/nginx/hl7.or.cr-access.log;    access_log /var/log/nginx/hl7.or.cr-access.log;

    error_log /var/log/nginx/hl7.or.cr-error.log;    error_log /var/log/nginx/hl7.or.cr-error.log;



    # Root - apunta al home del usuario hl7cr    # Root - apunta al home del usuario hl7cr

    root /home/hl7cr;    root /home/hl7cr;

    index index.html;    index index.html;



    # ========================================    # ========================================

    # Implementation Guides    # Implementation Guides

    # ========================================    # ========================================

    location /fhir/ig/ {    location /fhir/ig/ {

        alias /home/hl7cr/ig/;        alias /home/hl7cr/ig/;

        try_files $uri $uri/ =404;        try_files $uri $uri/ =404;

                

        # CORS        # CORS

        add_header Access-Control-Allow-Origin * always;        add_header Access-Control-Allow-Origin * always;

        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;

        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

                

        # Cache headers para contenido estático        # Cache headers para contenido estático

        location ~* \.(html|css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {        location ~* \.(html|css|js|png|jpg|jpeg|gif|svg|ico|woff|woff2|ttf|eot)$ {

            expires 1d;            expires 1d;

            add_header Cache-Control "public, immutable";            add_header Cache-Control "public, immutable";

        }        }

    }    }



    # ========================================    # ========================================

    # Package Registry    # Package Registry

    # ========================================    # ========================================

    location /fhir/packages/ {    location /fhir/packages/ {

        alias /home/hl7cr/packages/;        alias /home/hl7cr/packages/;

        autoindex on;        autoindex on;

        autoindex_format json;        autoindex_format json;

                

        # CORS completo        # CORS completo

        add_header Access-Control-Allow-Origin * always;        add_header Access-Control-Allow-Origin * always;

        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;        add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;

        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;        add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

                

        # Manejar preflight requests        # Manejar preflight requests

        if ($request_method = OPTIONS) {        if ($request_method = OPTIONS) {

            return 204;            return 204;

        }        }

                

        # Headers específicos para .tgz        # Headers específicos para .tgz

        location ~ \.tgz$ {        location ~ \.tgz$ {

            add_header Content-Type application/gzip always;            add_header Content-Type application/gzip always;

            add_header Content-Disposition 'attachment' always;            add_header Content-Disposition 'attachment' always;

            add_header Access-Control-Allow-Origin * always;            add_header Access-Control-Allow-Origin * always;

        }        }

                

        # Headers para package.manifest.json        # Headers para package.manifest.json

        location ~ package\.manifest\.json$ {        location ~ package\.manifest\.json$ {

            add_header Content-Type application/json always;            add_header Content-Type application/json always;

            add_header Access-Control-Allow-Origin * always;            add_header Access-Control-Allow-Origin * always;

        }        }

                

        # Headers para otros JSON        # Headers para otros JSON

        location ~ \.json$ {        location ~ \.json$ {

            add_header Content-Type application/json always;            add_header Content-Type application/json always;

            add_header Access-Control-Allow-Origin * always;            add_header Access-Control-Allow-Origin * always;

        }        }

    }    }



    # ========================================    # ========================================

    # Sitio principal (opcional)    # Sitio principal (opcional)

    # ========================================    # ========================================

    location / {    location / {

        try_files $uri $uri/ /index.html;        try_files $uri $uri/ /index.html;

    }    }



    # ========================================    # ========================================

    # Compresión    # Compresión

    # ========================================    # ========================================

    gzip on;    gzip on;

    gzip_vary on;    gzip_vary on;

    gzip_proxied any;    gzip_proxied any;

    gzip_comp_level 6;    gzip_comp_level 6;

    gzip_types text/plain text/css text/xml text/javascript     gzip_types text/plain text/css text/xml text/javascript 

               application/json application/javascript application/xml+rss                application/json application/javascript application/xml+rss 

               application/rss+xml application/atom+xml image/svg+xml                application/rss+xml application/atom+xml image/svg+xml 

               text/x-component text/x-js;               text/x-component text/x-js;



    # ========================================    # ========================================

    # Security Headers    # Security Headers

    # ========================================    # ========================================

    add_header X-Frame-Options "SAMEORIGIN" always;    add_header X-Frame-Options "SAMEORIGIN" always;

    add_header X-Content-Type-Options "nosniff" always;    add_header X-Content-Type-Options "nosniff" always;

    add_header X-XSS-Protection "1; mode=block" always;    add_header X-XSS-Protection "1; mode=block" always;

    add_header Referrer-Policy "no-referrer-when-downgrade" always;    add_header Referrer-Policy "no-referrer-when-downgrade" always;

}}

